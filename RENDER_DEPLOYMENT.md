# Render Deployment Guide

This guide covers deploying Smart Blood Bank System to Render.

## Prerequisites

1. Create a [Render account](https://render.com)
2. Connect your GitHub repository to Render
3. Have the project pushed to GitHub

## Issues Fixed for Render

### 1. ✅ Prophet Build Dependencies
- Updated `docker/Dockerfile.backend.render` to include `build-essential`, `g++`, `make`, `libgomp1`
- This ensures cmdstan (required by Prophet) compiles successfully

### 2. ✅ Dynamic Port Binding
- Backend now reads `PORT` env var from Render
- Fallback to 8000 for local dev
- Command: `gunicorn ... --bind 0.0.0.0:${PORT:-8000}`

### 3. ✅ Frontend Backend URL
- Frontend already supports `VITE_BACKEND_URL` env var
- Can be set to backend service URL at build time

### 4. ⚠️ Database Migrations
- **Manual Step Needed**: Run migrations after first deploy
- Use Render shell or SSH to run: `cd backend && alembic upgrade head`
- Or add a build command to Dockerfile if you prefer

### 5. ✅ Secrets Management
- Use Render Environment Variables (not .env files)
- `SECRET_KEY` and `JWT_SECRET_KEY` can be auto-generated by Render
- Sensitive keys (SMS_GATEWAY_API_KEY, etc.) set in Render dashboard

## Deployment Steps

### Option A: One-Click Deploy with render.yaml (Recommended)

1. Push `render.yaml` to GitHub
2. In Render dashboard: **+ New > Blueprint**
3. Connect GitHub repo
4. Choose `render.yaml`
5. Confirm services and environment variables
6. Click **Deploy Blueprint**

Render will create:
- PostgreSQL database (free starter tier)
- Backend service (web)
- Frontend service (web)

### Option B: Manual Deployment

#### Step 1: Create PostgreSQL Database
1. Render Dashboard > **+ New > PostgreSQL**
2. Set:
   - Name: `smart-blood-bank-db`
   - Database: `smart_blood_bank`
   - User: `bloodbank`
   - Region: Choose closest to you
   - Plan: **Free** (for testing)
3. Note the `Internal Database URL` for backend config

#### Step 2: Deploy Backend
1. **+ New > Web Service**
2. Connect GitHub repo
3. Set:
   - Name: `smart-blood-bank-backend`
   - Runtime: **Docker**
   - Dockerfile path: `docker/Dockerfile.backend.render`
   - Root directory: `backend`
   - Plan: **Free** (for testing)
   - Region: Same as database
4. Environment variables:
   ```
   DATABASE_URL=postgresql://bloodbank:<password>@<host>:5432/smart_blood_bank
   ENVIRONMENT=production
   DEBUG=False
   SECRET_KEY=<generate strong key or let Render auto-generate>
   JWT_SECRET_KEY=<generate strong key or let Render auto-generate>
   CORS_ORIGINS=https://<backend-url>,https://<frontend-url>
   LOG_LEVEL=INFO
   SCHEDULER_ENABLED=True
   ```
5. Click **Deploy**

#### Step 3: Deploy Frontend
1. **+ New > Web Service**
2. Connect GitHub repo
3. Set:
   - Name: `smart-blood-bank-frontend`
   - Runtime: **Docker**
   - Dockerfile path: `frontend/Dockerfile`
   - Root directory: `frontend`
   - Plan: **Free** (for testing)
   - Region: Same as backend
4. Environment variables:
   ```
   VITE_BACKEND_URL=https://smart-blood-bank-backend.onrender.com
   ```
   Replace with actual backend service URL
5. Click **Deploy**

#### Step 4: Run Database Migrations
After backend deploys:

1. Go to backend service in Render
2. Click **Shell** tab
3. Run:
   ```bash
   cd /app
   alembic upgrade head
   ```
4. Backend should now connect to database successfully

### Step 5: Test the Deployment
1. Open frontend URL in browser
2. Navigate to "Upload Inventory" or "Forecast" tabs
3. Test API connectivity

## Environment Variables to Set

### Backend (Required)
```
DATABASE_URL                    # Auto-filled from PostgreSQL instance
ENVIRONMENT                     # Set to "production"
DEBUG                          # Set to "False"
SECRET_KEY                     # Generate strong secret (32+ chars)
JWT_SECRET_KEY                 # Generate strong secret (32+ chars)
CORS_ORIGINS                   # Frontend URL + backend URL
LOG_LEVEL                      # "INFO" or "WARNING"
```

### Backend (Optional - for SMS/Email)
```
SMS_GATEWAY_ENABLED            # "False" by default
SMS_GATEWAY_API_KEY            # Twilio/AWS SNS key (if enabled)
TWILIO_ACCOUNT_SID             # Twilio account ID (if enabled)
TWILIO_AUTH_TOKEN              # Twilio auth token (if enabled)
TWILIO_PHONE_NUMBER            # Twilio phone number (if enabled)
EMAIL_ENABLED                  # "False" by default
SMTP_USER                      # Gmail/SMTP user (if enabled)
SMTP_PASSWORD                  # Gmail/SMTP password (if enabled)
```

### Frontend (Required)
```
VITE_BACKEND_URL               # https://smart-blood-bank-backend.onrender.com
```

## Known Limitations on Free Tier

1. **Spins down after 15 min of inactivity** — services will pause, taking ~30s to wake up
2. **Limited RAM/CPU** — Prophet forecasting might be slow (consider upgrading to paid plan)
3. **Database resets monthly** — don't rely on persistent data on free tier
4. **No background jobs** — APScheduler forecasting runs but may not persist across redeploys

## Troubleshooting

### Backend won't start: "prophet" build fails
- Ensure `docker/Dockerfile.backend.render` is used (has build deps)
- Check Render build logs for specific cmdstan errors

### Frontend shows "Cannot reach backend"
- Verify `VITE_BACKEND_URL` env var is set correctly
- Check backend service is running and health endpoint works
- Check CORS_ORIGINS includes frontend URL

### Database connection fails
- Verify `DATABASE_URL` is set from PostgreSQL instance
- Run migrations: Use Render Shell to run `alembic upgrade head`
- Check database user/password matches

### Migrations not running automatically
- Add to backend service start command (optional):
  ```bash
  sh -c "alembic upgrade head && gunicorn ..."
  ```
- Or manually run in Render Shell after deploy

## Production Recommendations

Before going to production:

1. **Upgrade to Paid Plan** — Free tier spins down services
2. **Use PostgreSQL Pro** — Better availability and backups
3. **Set up monitoring** — Render provides logs and metrics
4. **Configure auto-deploy** — Deploy on every GitHub push
5. **Use secrets** — Set sensitive vars in Render dashboard, not files
6. **HTTPS everywhere** — Render provides free SSL/TLS
7. **Add health checks** — Backend already has `/health` endpoint
8. **Set up notifications** — Get alerts on deploy failures

## Useful Commands

### View backend logs
```bash
# In Render dashboard, click backend service > Logs
```

### SSH into backend service
```bash
# In Render dashboard, click backend service > Shell
cd /app
ls -la
alembic current  # Check migration status
```

### Restart a service
```bash
# In Render dashboard, click service > Restart
```

## Additional Resources

- [Render Docs](https://render.com/docs)
- [Render Docker Deployments](https://render.com/docs/docker)
- [Render Environment Variables](https://render.com/docs/environment-variables)
- [Render PostgreSQL](https://render.com/docs/databases)
