# Render Deployment Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         RENDER CLOUD                            │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  Frontend Service (smart-blood-bank-frontend)             │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │  • Docker: Node 18 + Nginx                                │ │
│  │  • Port: 10000 (auto-assigned by Render)                  │ │
│  │  • Static React SPA                                       │ │
│  │  • URL: https://smart-blood-bank-frontend.onrender.com    │ │
│  │                                                            │ │
│  │  Environment:                                              │ │
│  │    VITE_API_URL=https://smart-blood-bank-backend.onrender.com │
│  └──────────────────────┬─────────────────────────────────────┘ │
│                         │                                       │
│                         │ HTTPS API Calls                       │
│                         │                                       │
│  ┌──────────────────────▼──────────────────────────────────────┐ │
│  │  Backend Service (smart-blood-bank-backend)                │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │  • Docker: Python 3.10 + FastAPI + Gunicorn              │ │
│  │  • Port: 8000 (auto-assigned by Render)                   │ │
│  │  • Workers: 2 Uvicorn workers                             │ │
│  │  • URL: https://smart-blood-bank-backend.onrender.com     │ │
│  │                                                            │ │
│  │  Features:                                                 │ │
│  │    ✓ Auto-runs migrations on startup                      │ │
│  │    ✓ Health check: /health                                │ │
│  │    ✓ API docs: /docs                                      │ │
│  │    ✓ CORS configured for frontend                         │ │
│  │    ✓ Background scheduler for forecasting                 │ │
│  │                                                            │ │
│  │  Environment:                                              │ │
│  │    DATABASE_URL=<auto-injected from DB>                   │ │
│  │    SECRET_KEY=<auto-generated>                            │ │
│  │    JWT_SECRET_KEY=<auto-generated>                        │ │
│  │    CORS_ORIGINS=*                                         │ │
│  │    ENVIRONMENT=production                                 │ │
│  └──────────────────────┬─────────────────────────────────────┘ │
│                         │                                       │
│                         │ PostgreSQL Connection                 │
│                         │ (Internal Network)                    │
│                         │                                       │
│  ┌──────────────────────▼──────────────────────────────────────┐ │
│  │  PostgreSQL Database (smart-blood-bank-db)                │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ │
│  │  • PostgreSQL 14+                                         │ │
│  │  • Database: smart_blood_bank                             │ │
│  │  • User: bloodbank_user                                   │ │
│  │  • Plan: Starter (free 90 days, then $7/mo)              │ │
│  │  • Internal access only (not publicly accessible)         │ │
│  │                                                            │ │
│  │  Tables:                                                   │ │
│  │    • hospitals                                            │ │
│  │    • inventory                                            │ │
│  │    • donors                                               │ │
│  │    • transfers                                            │ │
│  │    • forecasts                                            │ │
│  │    • notifications                                        │ │
│  │    • users                                                │ │
│  │    • audit_logs                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Communication Flow

### 1. User Access
```
User Browser
    ↓
https://smart-blood-bank-frontend.onrender.com
    ↓
Nginx serves React SPA
```

### 2. API Requests
```
React App (Frontend)
    ↓ HTTPS
    ↓ VITE_API_URL
https://smart-blood-bank-backend.onrender.com/api/*
    ↓
FastAPI Backend
    ↓ CORS Check (allow frontend origin)
    ↓
Process Request
```

### 3. Database Operations
```
FastAPI Backend
    ↓ DATABASE_URL (internal)
    ↓ SQLAlchemy ORM
PostgreSQL Database
    ↓
Return Data
```

## Deployment Configuration

### render.yaml Structure
```yaml
databases:
  - smart-blood-bank-db (PostgreSQL)

services:
  - smart-blood-bank-backend (Web Service)
    ├── Links to: smart-blood-bank-db
    ├── Dockerfile: Dockerfile.backend.render
    └── Auto-runs: alembic upgrade head

  - smart-blood-bank-frontend (Web Service)
    ├── Dockerfile: frontend/Dockerfile
    └── Points to: backend URL
```

## Security Features

### Network Security
- Database: Internal network only (not publicly accessible)
- Backend: HTTPS only, CORS configured
- Frontend: HTTPS only, static files

### Authentication
- JWT tokens for API authentication
- Bcrypt password hashing
- Role-based access control (admin/staff)

### Environment Variables
- Secrets auto-generated by Render
- DATABASE_URL injected securely
- No hardcoded credentials

## Startup Sequence

### 1. Database (First)
```
1. PostgreSQL instance provisioned (~2 min)
2. Database 'smart_blood_bank' created
3. User 'bloodbank_user' created
4. Connection string generated
```

### 2. Backend (Second)
```
1. Docker image built from Dockerfile.backend.render
2. Wait for database to be ready (psql check loop)
3. Run: alembic upgrade head (create tables)
4. Start: gunicorn with 2 uvicorn workers
5. Health check: /health returns 200 OK
6. Background scheduler starts
```

### 3. Frontend (Third)
```
1. Docker image built from frontend/Dockerfile
2. npm install dependencies
3. npm run build (with VITE_API_URL)
4. Nginx serves static files from /dist
5. SPA routing configured
```

## Monitoring & Logs

### Backend Logs
- Startup logs show migration status
- API request logs
- Error traces
- Scheduler job logs

### Frontend Logs
- Nginx access logs
- Build logs
- Static file serving

### Database Logs
- Connection logs
- Query performance
- Backup status

## Scaling Considerations

### Free Tier Limitations
- Services sleep after 15 min idle
- First request takes ~30s to wake
- 512 MB RAM per service
- Shared CPU

### Starter Tier Benefits
- Always on (no sleep)
- 512 MB RAM
- Shared CPU
- Better for production

### Scaling Options
1. Upgrade to Standard ($25/mo): 2GB RAM, dedicated CPU
2. Add more workers: Increase Gunicorn workers
3. Database scaling: Upgrade to larger DB plan
4. CDN: Add Cloudflare for static assets

## Backup & Recovery

### Database Backups
- Automatic daily backups (Render managed)
- Point-in-time recovery available
- Manual backup via pg_dump

### Code Backups
- Git repository (GitHub)
- Render keeps deployment history
- Rollback available via Render dashboard

## Cost Breakdown

### Free Tier (90 days)
- Database: Free
- Backend: Free (with sleep)
- Frontend: Free (with sleep)
- **Total: $0/month**

### After 90 Days (Starter)
- Database: $7/month
- Backend: $7/month
- Frontend: $7/month
- **Total: $21/month**

### Production (Standard)
- Database: $20/month
- Backend: $25/month
- Frontend: $25/month
- **Total: $70/month**

## Performance Metrics

### Expected Response Times
- Health check: <100ms
- API requests: 200-500ms
- Database queries: 50-200ms
- Frontend load: 1-2s (first load)

### Capacity
- Concurrent users: ~50-100 (Starter)
- API requests: ~1000/min
- Database connections: 22 (default)

## Maintenance

### Regular Tasks
- Monitor logs for errors
- Check database size
- Review API performance
- Update dependencies

### Updates
- Push to GitHub → Auto-deploy
- Manual deploy via Render dashboard
- Rollback if needed

## Support Resources

- Render Status: https://status.render.com
- Render Docs: https://render.com/docs
- Community: https://community.render.com
- Support: support@render.com
